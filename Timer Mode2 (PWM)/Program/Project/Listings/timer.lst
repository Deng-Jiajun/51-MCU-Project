C51 COMPILER V9.60.0.0   TIMER                                                             03/22/2022 16:26:52 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN .\Objects\timer.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\Source\timer.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\timer.lst) TABS(2) OBJECT(.\Objects\timer.obj)

line level    source

   1          #include <reg51.h>
   2          #include "timer.h"
   3          #include "led.h"
   4          #include "delay.h"
   5          
   6          /* 方式 0 定时器只有 16 位，最大值 65535，最多只能定时 8.192ms，所以引入一个 cou
             -nt 计算中断的次数，以中断次数来实现更大的触发执行间隔（count ms）*/
   7          unsigned int COUNT_T0_LED0 = 0;
   8          unsigned int COUNT_T1_LED1 = 0;
   9          
  10          // 闪烁模式（对应 LED1 的占空比：0%、20%、50%、80%）
  11          unsigned char FLASH_MODE = 0;
  12          unsigned char DUTY_CYCLE_LED1[4] = {0, 20, 50, 80};
  13          
  14          // LED0 的占空比 [0,100]
  15          unsigned char DUTY_CYCLE = 0;
  16          
  17          // 占空比是否应递增
  18          unsigned char DUTY_CYCLE_INCREASE = 1;
  19          
  20          // 初始化定时器 T0（方式2）
  21          void Init_T0_MODE2(void)
  22          {
  23   1          /* 配置定时器 */
  24   1      
  25   1          TMOD &= 0xF0; //（低 4 位全置 0）
  26   1          TMOD |= 0x02; // 方式 2（8 位定时器）、定时模式、无需门控制
  27   1          TR0 = 1;      // 开启定时器 0
  28   1      
  29   1          // 周期 200μs = 0.2ms，2^8 = 256 （256 - 200 = 56）
  30   1          TL0 = 56; // 赋值初值 8 位（用于计数的初始值）
  31   1          TH0 = 56; // 赋值初值 8 位（用于覆盖的初始值）
  32   1      
  33   1          TF0 = 0; // 清标志位
  34   1      
  35   1          /* 配置中断1 */
  36   1          ET0 = 1; // 允许定时器 0 中断
  37   1          EA = 1;  // 打开总中断
  38   1          PT0 = 0; // 配置优先级，低
  39   1      }
  40          
  41          // 初始化定时器 T1（方式2）
  42          void Init_T1_MODE2(void)
  43          {
  44   1          /* 配置定时器 */
  45   1      
  46   1          TMOD &= 0x0F; //（高 4 位全置 0）
  47   1          TMOD |= 0x20; // 方式 2（8 位定时器）、定时模式、无需门控制
  48   1          TR1 = 1;      // 开启定时器 1
  49   1      
  50   1          // 周期 200μs = 0.2ms，2^8 = 256 （256 - 200 = 56）
  51   1          TL1 = 56; // 赋值初值 8 位（用于计数的初始值）
  52   1          TH1 = 56; // 赋值初值 8 位（用于覆盖的初始值）
  53   1      
C51 COMPILER V9.60.0.0   TIMER                                                             03/22/2022 16:26:52 PAGE 2   

  54   1          TF1 = 0; // 清标志位
  55   1      
  56   1          /* 配置中断1 */
  57   1          ET1 = 1; // 允许定时器 0 中断
  58   1          EA = 1;  // 打开总中断
  59   1          PT1 = 0; // 配置优先级，低
  60   1      }
  61          
  62          // 定时器 T0（方式2） 中断处理程序（中断向量 1）
  63          void T0_MODE2_IRQHandler(void) interrupt 1
  64          {
  65   1          /**
  66   1           * PWM 调光
  67   1           * 以 20ms 为一个周期，每0.2ms中断一次
  68   1           *
  69   1           */
  70   1          COUNT_T0_LED0++;
  71   1      
  72   1          // 一个周期结束（20ms）
  73   1          if (COUNT_T0_LED0 == 100)
  74   1          {
  75   2              COUNT_T0_LED0 = 0;
  76   2              TurnOffLED(0);
  77   2      
  78   2              // 每个周期改变一次占空比
  79   2              // 100 之前递增，到达 100 开始递减，到 0 又开始递增，以此循环
  80   2              if (DUTY_CYCLE_INCREASE == 1)
  81   2                  DUTY_CYCLE++;
  82   2              if (DUTY_CYCLE_INCREASE == 0)
  83   2                  DUTY_CYCLE--;
  84   2      
  85   2              if (DUTY_CYCLE == 100)
  86   2                  DUTY_CYCLE_INCREASE = 0;
  87   2              if (DUTY_CYCLE == 0)
  88   2                  DUTY_CYCLE_INCREASE = 1;
  89   2          }
  90   1      
  91   1          // 这个占空比写反了，超过这个值才开始亮
  92   1          if (COUNT_T0_LED0 == DUTY_CYCLE)
  93   1          {
  94   2              TurnOnLED(0);
  95   2          }
  96   1      }
  97          
  98          // 定时器 T1（方式2） 中断处理程序（中断向量 3）
  99          void T1_MODE2_IRQHandler(void) interrupt 3
 100          {
 101   1          COUNT_T1_LED1++;
 102   1      
 103   1          // 一个周期结束（20ms）
 104   1          if (COUNT_T1_LED1 == 100)
 105   1          {
 106   2              COUNT_T1_LED1 = 0;
 107   2              TurnOnLED(1);
 108   2          }
 109   1      
 110   1          // 如果超过占空比，关灯
 111   1          if (COUNT_T1_LED1 == DUTY_CYCLE_LED1[FLASH_MODE])
 112   1          {
 113   2              TurnOffLED(1);
 114   2          }
 115   1      }
C51 COMPILER V9.60.0.0   TIMER                                                             03/22/2022 16:26:52 PAGE 3   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    269    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     11    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
